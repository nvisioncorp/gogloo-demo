// ============================================
// MODULE PROMO BAR - GOGLOO
// Fichier: promo-bar.js
// Version: 2.1.0 (CORRIG√â - Sans gestion padding-top)
// Description: Gestion compl√®te de la barre promo sticky avec rotation automatique
// ============================================

(function initPromoBarModule() {
    'use strict';

    console.log('üéØ Module Promo Bar charg√©');

    // ============================================
    // CONFIGURATION
    // ============================================

    const CONFIG = {
        // Liste des promotions √† afficher en rotation
        promos: [
            {
                text: "-15% sur les cosm√©tiques cette semaine | Livraison gratuite d√®s 30 000 FCFA",
                link: "/promotions",
                linkText: "En savoir plus"
            },
            {
                text: "üéâ Nouveaut√©s High-Tech en stock | Profitez de -20% sur tout l'√©lectronique",
                link: "/high-tech",
                linkText: "D√©couvrir"
            },
            {
                text: "üöö Livraison express disponible | Commandez avant 15h, livr√© demain",
                link: "/livraison",
                linkText: "Commander"
            },
            {
                text: "üíé Programme fid√©lit√© : gagnez des points √† chaque achat !",
                link: "/fidelite",
                linkText: "Rejoindre"
            }
        ],

        // D√©lais en millisecondes
        rotationDelay: 5000,        // Rotation toutes les 5 secondes
        fadeOutDuration: 300,       // Dur√©e du fade out
        fadeInDuration: 300,        // Dur√©e du fade in
        closeDuration: 300,         // Dur√©e de l'animation de fermeture

        // Date d'expiration (optionnel)
        expirationDate: '2026-12-31T23:59:59',

        // LocalStorage keys (uniquement pour l'index, pas pour la fermeture)
        storageKeys: {
            currentIndex: 'promoCurrentIndex'
        },

        // Options
        pauseOnHover: true,         // Pause la rotation au hover (desktop uniquement)
        trackAnalytics: true,       // Activer le tracking analytics
        persistIndex: false         // Sauvegarder l'index de promo entre les sessions
    };

    // ============================================
    // VARIABLES GLOBALES
    // ============================================

    let currentPromoIndex = 0;
    let rotationInterval = null;
    let isPaused = false;
    let isTransitioning = false;
    let isClosedThisSession = false;

    let promoBar = null;
    let promoText = null;
    let promoLink = null;
    let closeButton = null;

    // ============================================
    // INITIALISATION
    // ============================================

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    function init() {
        console.log('üöÄ Initialisation de la Promo Bar...');

        // R√©cup√©rer les √©l√©ments DOM
        promoBar = document.getElementById('promo-bar');
        promoText = document.getElementById('promo-text');
        promoLink = document.querySelector('.promo-link');
        closeButton = document.querySelector('.close-promo');

        if (!promoBar || !promoText || !promoLink) {
            console.warn('‚ö†Ô∏è √âl√©ments de la Promo Bar introuvables');
            return;
        }

        // V√©rifier la date d'expiration
        if (isPromoExpired()) {
            hidePromoBar();
            console.log('üìÖ Promo Bar masqu√©e (promotion expir√©e)');
            return;
        }

        // Toujours afficher la promo au chargement
        showPromoBar();

        // Charger l'index de promo sauvegard√©
        if (CONFIG.persistIndex) {
            const savedIndex = localStorage.getItem(CONFIG.storageKeys.currentIndex);
            if (savedIndex !== null) {
                currentPromoIndex = parseInt(savedIndex, 10);
                if (currentPromoIndex >= CONFIG.promos.length) {
                    currentPromoIndex = 0;
                }
            }
        }

        // Afficher la premi√®re promo
        displayPromo(currentPromoIndex);

        // Configurer les event listeners
        setupEventListeners();

        // D√©marrer la rotation automatique
        startRotation();

        // Tracking analytics
        if (CONFIG.trackAnalytics) {
            trackEvent('promo_bar_viewed', {
                promo_text: promoText.textContent,
                promo_index: currentPromoIndex
            });
        }

        console.log('‚úÖ Promo Bar initialis√©e avec succ√®s');
    }

    // ============================================
    // V√âRIFICATIONS
    // ============================================

    function isPromoExpired() {
        if (!CONFIG.expirationDate) return false;
        
        const expirationDate = new Date(CONFIG.expirationDate);
        const now = new Date();
        
        return now > expirationDate;
    }

    // ============================================
    // AFFICHAGE DES PROMOS
    // ============================================

    function displayPromo(index) {
        if (index < 0 || index >= CONFIG.promos.length) {
            console.warn(`‚ö†Ô∏è Index invalide: ${index}`);
            return;
        }

        const promo = CONFIG.promos[index];

        // Mettre √† jour le contenu
        promoText.textContent = promo.text;
        promoLink.href = promo.link;
        promoLink.textContent = promo.linkText || 'En savoir plus';

        // Sauvegarder l'index si option activ√©e
        if (CONFIG.persistIndex) {
            localStorage.setItem(CONFIG.storageKeys.currentIndex, index.toString());
        }

        console.log(`üì¢ Promo ${index + 1}/${CONFIG.promos.length} affich√©e`);
    }

    function transitionToNextPromo() {
        if (isTransitioning) return;

        isTransitioning = true;

        // Fade out
        fadeOut(promoText, CONFIG.fadeOutDuration);

        setTimeout(() => {
            // Passer √† la promo suivante
            currentPromoIndex = (currentPromoIndex + 1) % CONFIG.promos.length;
            displayPromo(currentPromoIndex);

            // Fade in
            fadeIn(promoText, CONFIG.fadeInDuration);

            // Tracking analytics
            if (CONFIG.trackAnalytics) {
                trackEvent('promo_rotated', {
                    promo_index: currentPromoIndex,
                    promo_text: promoText.textContent
                });
            }

            setTimeout(() => {
                isTransitioning = false;
            }, CONFIG.fadeInDuration);

        }, CONFIG.fadeOutDuration);
    }

    // ============================================
    // ROTATION AUTOMATIQUE
    // ============================================

    function startRotation() {
        if (rotationInterval) {
            clearInterval(rotationInterval);
        }

        rotationInterval = setInterval(() => {
            if (!isPaused && !isClosedThisSession) {
                transitionToNextPromo();
            }
        }, CONFIG.rotationDelay);

        console.log('‚ñ∂Ô∏è Rotation automatique d√©marr√©e');
    }

    function stopRotation() {
        if (rotationInterval) {
            clearInterval(rotationInterval);
            rotationInterval = null;
        }
        console.log('‚èπÔ∏è Rotation automatique arr√™t√©e');
    }

    function pauseRotation() {
        isPaused = true;
        console.log('‚è∏Ô∏è Rotation en pause');
    }

    function resumeRotation() {
        isPaused = false;
        console.log('‚ñ∂Ô∏è Rotation reprise');
    }

    // ============================================
    // FERMETURE TEMPORAIRE (SESSION SEULEMENT)
    // ============================================

    function closePromoBar() {
        if (!promoBar) return;

        // Marquer comme ferm√©e pour cette session uniquement
        isClosedThisSession = true;

        // Arr√™ter la rotation
        stopRotation();

        // Animation de fermeture
        promoBar.classList.add('closing');

        // Tracking analytics
        if (CONFIG.trackAnalytics) {
            trackEvent('promo_bar_closed', {
                promo_index: currentPromoIndex,
                promo_text: promoText.textContent
            });
        }

        setTimeout(() => {
            hidePromoBar();
            console.log('‚ùå Promo Bar ferm√©e (temporaire - cette session uniquement)');
        }, CONFIG.closeDuration);
    }

    function hidePromoBar() {
        if (promoBar) {
            promoBar.style.display = 'none';
        }
    }

    function showPromoBar() {
        if (promoBar) {
            promoBar.style.display = 'flex';
            promoBar.classList.remove('closing');
        }
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================

    function setupEventListeners() {
        // Bouton de fermeture
        if (closeButton) {
            closeButton.addEventListener('click', closePromoBar);
        }

        // Pause au hover (desktop uniquement)
        if (CONFIG.pauseOnHover && !isTouchDevice()) {
            promoBar.addEventListener('mouseenter', pauseRotation);
            promoBar.addEventListener('mouseleave', resumeRotation);
        }

        // Tracking des clics sur le lien
        if (promoLink) {
            promoLink.addEventListener('click', (e) => {
                if (CONFIG.trackAnalytics) {
                    trackEvent('promo_link_clicked', {
                        promo_index: currentPromoIndex,
                        promo_link: promoLink.href,
                        promo_text: promoText.textContent
                    });
                }
            });
        }

        // Navigation clavier (accessibilit√©)
        if (closeButton) {
            closeButton.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    closePromoBar();
                }
            });
        }

        console.log('üéØ Event listeners configur√©s');
    }

    // ============================================
    // ANIMATIONS - FADE IN/OUT
    // ============================================

    function fadeOut(element, duration) {
        if (!element) return;
        element.style.transition = `opacity ${duration}ms ease`;
        element.style.opacity = '0';
    }

    function fadeIn(element, duration) {
        if (!element) return;
        element.style.transition = `opacity ${duration}ms ease`;
        element.style.opacity = '1';
    }

    // ============================================
    // ANALYTICS TRACKING
    // ============================================

    function trackEvent(eventName, params = {}) {
        // Google Analytics 4
        if (typeof gtag !== 'undefined') {
            gtag('event', eventName, {
                event_category: 'promo_bar',
                ...params
            });
        }
        
        // Facebook Pixel
        if (typeof fbq !== 'undefined') {
            fbq('trackCustom', eventName, params);
        }
        
        console.log(`üìä Event tracked: ${eventName}`, params);
    }

    // ============================================
    // UTILITAIRES
    // ============================================

    function isTouchDevice() {
        return window.matchMedia('(hover: none) and (pointer: coarse)').matches;
    }

    function getDeviceType() {
        const width = window.innerWidth;
        if (width >= 1025) return 'desktop';
        if (width >= 769 && width <= 1024) return 'tablet';
        if (width === 768) return 'tablet-768';
        if (width <= 320) return 'small-mobile';
        return 'mobile';
    }

    // ============================================
    // API PUBLIQUE
    // ============================================

    window.GoglooPromoBar = {
        /**
         * Afficher manuellement la promo bar
         */
        show: function() {
            isClosedThisSession = false;
            showPromoBar();
            startRotation();
            console.log('‚úÖ Promo Bar affich√©e');
        },

        /**
         * Masquer manuellement la promo bar
         */
        hide: function() {
            closePromoBar();
        },

        /**
         * Aller √† une promo sp√©cifique
         * @param {number} index - Index de la promo (0-based)
         */
        goToPromo: function(index) {
            if (index >= 0 && index < CONFIG.promos.length) {
                stopRotation();
                fadeOut(promoText, CONFIG.fadeOutDuration);
                
                setTimeout(() => {
                    currentPromoIndex = index;
                    displayPromo(currentPromoIndex);
                    fadeIn(promoText, CONFIG.fadeInDuration);
                    startRotation();
                }, CONFIG.fadeOutDuration);
            } else {
                console.error(`‚ùå Index invalide: ${index} (valide: 0-${CONFIG.promos.length - 1})`);
            }
        },

        /**
         * Passer √† la promo suivante
         */
        next: function() {
            transitionToNextPromo();
        },

        /**
         * Revenir √† la promo pr√©c√©dente
         */
        previous: function() {
            stopRotation();
            fadeOut(promoText, CONFIG.fadeOutDuration);
            
            setTimeout(() => {
                currentPromoIndex = (currentPromoIndex - 1 + CONFIG.promos.length) % CONFIG.promos.length;
                displayPromo(currentPromoIndex);
                fadeIn(promoText, CONFIG.fadeInDuration);
                startRotation();
            }, CONFIG.fadeOutDuration);
        },

        /**
         * Mettre en pause la rotation
         */
        pause: function() {
            pauseRotation();
        },

        /**
         * Reprendre la rotation
         */
        resume: function() {
            resumeRotation();
        },

        /**
         * Arr√™ter compl√®tement la rotation
         */
        stop: function() {
            stopRotation();
        },

        /**
         * Red√©marrer la rotation
         */
        restart: function() {
            startRotation();
        },

        /**
         * Ajouter une nouvelle promo dynamiquement
         * @param {object} promo - {text, link, linkText}
         */
        addPromo: function(promo) {
            if (!promo || !promo.text || !promo.link) {
                console.error('‚ùå Format de promo invalide. Requis: {text, link, linkText}');
                return;
            }

            CONFIG.promos.push(promo);
            console.log(`‚úÖ Promo ajout√©e (total: ${CONFIG.promos.length})`);
        },

        /**
         * Supprimer une promo
         * @param {number} index - Index de la promo √† supprimer
         */
        removePromo: function(index) {
            if (index >= 0 && index < CONFIG.promos.length) {
                const removed = CONFIG.promos.splice(index, 1);
                console.log(`‚úÖ Promo supprim√©e: "${removed[0].text}" (total: ${CONFIG.promos.length})`);
                
                // Ajuster l'index actuel si n√©cessaire
                if (currentPromoIndex >= CONFIG.promos.length) {
                    currentPromoIndex = 0;
                    displayPromo(currentPromoIndex);
                }
            } else {
                console.error(`‚ùå Index invalide: ${index}`);
            }
        },

        /**
         * Obtenir l'index actuel
         * @returns {number}
         */
        getCurrentIndex: function() {
            return currentPromoIndex;
        },

        /**
         * Obtenir la promo actuelle
         * @returns {object}
         */
        getCurrentPromo: function() {
            return CONFIG.promos[currentPromoIndex];
        },

        /**
         * Obtenir toutes les promos
         * @returns {array}
         */
        getAllPromos: function() {
            return CONFIG.promos;
        },

        /**
         * V√©rifier si la promo bar est visible
         * @returns {boolean}
         */
        isVisible: function() {
            return promoBar && promoBar.style.display !== 'none';
        },

        /**
         * V√©rifier si la rotation est active
         * @returns {boolean}
         */
        isRotating: function() {
            return rotationInterval !== null && !isPaused;
        },

        /**
         * Obtenir des statistiques d√©taill√©es
         * @returns {object}
         */
        getStats: function() {
            return {
                currentIndex: currentPromoIndex,
                currentPromo: CONFIG.promos[currentPromoIndex],
                totalPromos: CONFIG.promos.length,
                isVisible: this.isVisible(),
                isRotating: this.isRotating(),
                isPaused: isPaused,
                isTransitioning: isTransitioning,
                isClosedThisSession: isClosedThisSession,
                isExpired: isPromoExpired(),
                deviceType: getDeviceType(),
                promoBarHeight: promoBar ? promoBar.offsetHeight : 0
            };
        },

        /**
         * Mettre √† jour la configuration
         * @param {object} newConfig - Nouvelles options
         */
        updateConfig: function(newConfig) {
            const oldRotationDelay = CONFIG.rotationDelay;
            
            Object.assign(CONFIG, newConfig);
            
            // Red√©marrer la rotation si le d√©lai a chang√©
            if (newConfig.rotationDelay && newConfig.rotationDelay !== oldRotationDelay) {
                stopRotation();
                startRotation();
            }
            
            console.log('‚öôÔ∏è Configuration mise √† jour', CONFIG);
        },

        /**
         * Obtenir la configuration actuelle
         * @returns {object}
         */
        getConfig: function() {
            return { ...CONFIG };
        },

        /**
         * Afficher les commandes disponibles
         */
        help: function() {
            console.log(`
üéØ API PROMO BAR - COMMANDES DISPONIBLES:

üìä Informations:
  - GoglooPromoBar.getStats()           : Statistiques compl√®tes
  - GoglooPromoBar.getCurrentPromo()    : Promo actuelle
  - GoglooPromoBar.getAllPromos()       : Liste des promos
  - GoglooPromoBar.getConfig()          : Configuration actuelle

üéÆ Contr√¥les:
  - GoglooPromoBar.show()               : Afficher
  - GoglooPromoBar.hide()               : Masquer
  - GoglooPromoBar.next()               : Promo suivante
  - GoglooPromoBar.previous()           : Promo pr√©c√©dente
  - GoglooPromoBar.goToPromo(index)     : Aller √† la promo N

‚èØÔ∏è Rotation:
  - GoglooPromoBar.pause()              : Pause
  - GoglooPromoBar.resume()             : Reprendre
  - GoglooPromoBar.stop()               : Arr√™ter
  - GoglooPromoBar.restart()            : Red√©marrer

‚úèÔ∏è Modifications:
  - GoglooPromoBar.addPromo({...})      : Ajouter une promo
  - GoglooPromoBar.removePromo(index)   : Supprimer une promo
  - GoglooPromoBar.updateConfig({...})  : Modifier la config

üîß Utilitaires:
  - GoglooPromoBar.help()               : Afficher cette aide
            `);
        }
    };

    // ============================================
    // NETTOYAGE AU D√âCHARGEMENT
    // ============================================

    window.addEventListener('beforeunload', () => {
        stopRotation();
        console.log('üßπ Nettoyage Promo Bar effectu√©');
    });

    // ============================================
    // EXPOSITION DE L'API
    // ============================================

    console.log('‚úÖ API publique GoglooPromoBar expos√©e');
    console.log('üí° Tapez GoglooPromoBar.help() pour voir les commandes disponibles');

})();